<html>
  <head></head>
  <body>
    <div id="game"></div>
    <script src="https://raw.githubusercontent.com/craftyjs/Crafty-Distro/nightlies/crafty.js"></script>
    <script>
    /*****************
     **** ENGINE *****
     *****************/
    Crafty.c("Isometric", {
        _d: 0,
        _iso: null,

        init: function() {
            // define public property 'd'
            Crafty.defineField(this, "d", function() { return this._d; }, function(newValue) {
                var oldValue = this._d;
                if (newValue !== oldValue) {
                    this._d = newValue;
                    this.trigger("ResizeDepth", oldValue);
                }
            });
            // hide private property '_d'
            Object.defineProperty(this, "_d", {
                value : 0,
                writable : true,
                enumerable : false,
                configurable : false
            });

            
            this._iso = Crafty.e("2D").attr({ _controller: this });
            this.bind("Move", this._updateIso);
            this.bind("reorder", this._updateIso);
            this.bind("ResizeDepth", this._updateIso);
            var resizeIso = function(evt) {
                var otherAxis = evt.axis === 'w' ? 'h' : 'w';
                this[otherAxis] = this[evt.axis];
                this._updateIso();
            };
            this.bind("Resize", resizeIso);
            var rotateIso = function(e) {
                if (e.deg % 90 !== 0)
                    Crafty.error("Only rotations that are multiples of 90 degrees are supported in Isometric component!");
                this._updateIso();
            };
            this.bind("Rotate", rotateIso);
            this._updateIso();
        },

        _updateIso: function() {
            var iso = this._iso;
            var mbr = this._mbr || this;
            iso.x = mbr._x - mbr._y - mbr._w;
            iso.y = (mbr._x + mbr._y) / 2 - (this._z + this._d);
            iso.z = mbr._x + mbr._y + mbr._w + this._z * 3 + this._d * 2;
            iso.w = mbr._w + mbr._h;
            iso.h = mbr._h + this._d;
        },

        isometric: function(components, callback) {
            var iso = this._iso;
            iso.requires(components);
            if (callback) callback.call(iso, this);

            return this;
        }
    });

    var Isometric = {
        placeTile: function(x, y, tileSize, tile) {
            var z = (typeof tile.z !== "undefined") ? tile.z : 0,
                w = (typeof tile.w !== "undefined") ? tile.w : 1,
                h = (typeof tile.h !== "undefined") ? tile.h : 1,
                d = (typeof tile.d !== "undefined") ? tile.d : 1,
                c = (typeof tile.c === "string") ? "2D, Isometric, " + tile.c : "2D, Isometric",
                i = tile.i;

            return Crafty.e(c)
                    .attr({ x: x * tileSize, y: y * tileSize, z: z * tileSize,
                            w: w * tileSize, h: h * tileSize, d: d * tileSize })
                    .isometric(i);
        },
        placeTileMap: function(tileSize, map) {
            var mapEntity = Crafty.e("2D").attr({ x: 0, y: 0, z: 0});

            var isoMap = [];
            for (var i = 0; i < map.length; i++) {
                isoMap[i] = [];
                for (var j = 0; j < map[i].length; j++) {
                    isoMap[i][j] = [];

                    var tile = map[i][j];
                    if (tile && tile.constructor === Array) {

                        var lowerTileK = -1;
                        for (var k = 0; k < tile.length; k++) {
                            var subTile = tile[k];
                            if (subTile) {
                                subTile.z = (typeof subTile.z !== "undefined") ? subTile.z : k;
                                subTile.d = (typeof subTile.d !== "undefined") ? subTile.d : k - lowerTileK;
                                var tileEntity = this.placeTile(i, j, tileSize, subTile);
                                isoMap[i][j][k] = tileEntity;
                                mapEntity.attach(tileEntity);

                                lowerTileK = k;
                            }
                        }

                    } else if (tile) {
                        var tileEntity = this.placeTile(i, j, tileSize, tile);
                        isoMap[i][j][0] = tileEntity;
                        mapEntity.attach(tileEntity);
                    }
                }
            }

            mapEntity._isoMap = isoMap;
            return mapEntity;
        }
    };

    /*****************
     ****** GAME *****
     *****************/
    Crafty.init(600, 600);
    Crafty.background('gray');

    Crafty.sprite(128, 64, "https://raw.githubusercontent.com/craftyjs/demos/master/devDemos/isometric/iso-sprites.png", {
        block: [0,0,1,2],
        player: [1,0,1,2],
        tower: [2,0,1,4],
        big: [0,2,2,3],
        plane: [2,4,1,1]
    });

    var size = 64;

    // TILE MAP
    var map = [ [], [], [], [], [], [], [] ]; // 7x7
    var comps = "Solid, Collision";
    // simple block
    map[6][6] = {c: comps, i: "DOM, block"};
    // big block
    map[4][4] = {w: 2, h: 2, c: comps, i: "DOM, big"};
    // flat planes
    map[1][1] = {d: 0, i: "DOM, plane"};
    map[1][2] = {d: 0, i: "DOM, plane"};
    map[2][1] = {d: 0, i: "DOM, plane"};
    // stacked blocks
    map[0][0] = [ {c: comps, i: "DOM, block"}, {c: comps, i: "DOM, block"} ];
    map[1][0] = [ {d: 0, i: "DOM, plane"}, {d: 0, i: "DOM, plane"}, {d: 0, i: "DOM, plane"}];
    map[0][1] = [ {d: 0, i: "DOM, plane"}, {d: 0, i: "DOM, plane"}, {d: 0, i: "DOM, plane"}];
    map[0][2] = [ {c: comps, i: "DOM, block"}, {c: comps, i: "DOM, block"} ];
    map[2][0] = [ {c: comps, i: "DOM, block"}, {c: comps, i: "DOM, block"} ];
    map[0][3] = [ {c: comps, i: "DOM, block"}, {c: comps, i: "DOM, block"}, {c: comps, i: "DOM, block"} ];
    map[3][0] = [ {c: comps, i: "DOM, block"}, {c: comps, i: "DOM, block"}, {c: comps, i: "DOM, block"} ];
    var mapEntity = Isometric.placeTileMap(size, map);

    var keyRotations = {};
    keyRotations[Crafty.keys.NUMPAD_4] = 90;
    keyRotations[Crafty.keys.NUMPAD_8] = 0,
    keyRotations[Crafty.keys.NUMPAD_6] = -90,
    keyRotations[Crafty.keys.NUMPAD_2] = -180
    mapEntity.bind("KeyDown", function(e) {
        var rotation = keyRotations[e.key];
        if (typeof rotation !== "undefined") {
            this.rotation = rotation;
        }
    });


    // PLAYER
    var playerEntity = Crafty.e("2D, Multiway, Collision, Isometric")
        .attr({ x: 1 * size, y: 1 * size, z: 0 * size,
                w: 1 * size, h: 1 * size, d: 1 * size })
        .collision(new Crafty.polygon([1,1, size-1,1, size-1,size-1, 1,size-1]))
        .bind("Moved", function(evt) {
            var collisionDatas = this.hit('Solid');
            for (var i = 0; i < collisionDatas.length; i++) {
                var collider = collisionDatas[i].obj;
                if (this._z < collider._z + collider._d && this._z + this._d > collider._z) {
                    this[evt.axis] = evt.oldValue;
                    break;
                }
            }
        })
        .multiway(100, {
            UP_ARROW: -135, W: -135,
            DOWN_ARROW: 45, S: 45,
            RIGHT_ARROW: -45, D: -45,
            LEFT_ARROW: 135, A: 135
        })
        .bind("KeyDown", function(e) {
            if (e.key === Crafty.keys.ADD)
                this.z += size;
            else if (e.key === Crafty.keys.SUBSTRACT)
                this.z -= size;
        })
        .isometric("2D, DOM, player");
    mapEntity.attach(playerEntity);


    // VIEWPORT
    Crafty.viewport.clampToEntities = false;
    Crafty.viewport.follow(playerEntity._iso);
    </script>
  </body>
</html>
