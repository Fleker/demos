<html>
  <head></head>
  <body>
    <div id="game"></div>
    <script src="https://raw.githubusercontent.com/craftyjs/Crafty-Distro/nightlies/crafty.js"></script>
    <script>
    /*****************
     **** ENGINE *****
     *****************/
    Crafty.c("Isometric", {
        _d: 0,
        _isoDisplay: null,

        init: function() {
            // define public property 'd'
            Crafty.defineField(this, "d", function() { return this._d; }, function(newValue) {
                var oldValue = this._d;
                if (newValue !== oldValue) {
                    this._d = newValue;
                    this.trigger("ResizeDepth", oldValue);
                }
            });
            // hide private property '_d'
            Object.defineProperty(this, "_d", {
                value : 0,
                writable : true,
                enumerable : false,
                configurable : false
            });

            
            this._isoDisplay = Crafty.e("2D").attr({ _isoController: this });
            this.bind("Move", this._updateIso);
            this.bind("reorder", this._updateIso);
            this.bind("ResizeDepth", this._updateIso);
            var resizeIso = function(evt) {
                var otherAxis = evt.axis === 'w' ? 'h' : 'w';
                this[otherAxis] = this[evt.axis];
                this._updateIso();
            };
            this.bind("Resize", resizeIso);
            var rotateIso = function(e) {
                if (e.deg % 90 !== 0)
                    Crafty.error("Only rotations that are multiples of 90 degrees are supported in Isometric component!");
                this._updateIso();
            };
            this.bind("Rotate", rotateIso);
            this._updateIso();
        },

        _updateIso: function() {
            var iso = this._isoDisplay;
            var mbr = this._mbr || this;
            iso.x = mbr._x - mbr._y - mbr._w;
            iso.y = (mbr._x + mbr._y) / 2 - (this._z + this._d);
            iso.z = mbr._x + mbr._y + mbr._w + this._z * 1e6 + (this._d ? 1e5 : 0);
            iso.w = mbr._w + mbr._h;
            iso.h = mbr._h + this._d;
        },

        isometric: function(components, callback) {
            var iso = this._isoDisplay;
            iso.requires(components);
            if (callback) callback.call(iso, this);

            return this;
        }
    });

    Crafty.c("Collision3D", {
        init: function() {
            this.requires("Collision");
        },
        hit3D: function(component) {
            var collisionDatas = this.hit(component);

            var i = collisionDatas.length;
            while (--i >= 0) {
                var collider = collisionDatas[i].obj;
                if (!(this._z < collider._z + collider._d && this._z + this._d > collider._z))
                    collisionDatas.splice(i, 1);
            }

            return (collisionDatas.length ? collisionDatas : false);
        }
    });

    var Isometric = {
        _annotateTile: function(x, y, z, w, h, d, tile) {
            tile.addComponent("TILE");

            for (var i = x; i < x + w; i++) {
                tile.addComponent("TILE_X[" + i + "]");
                for (var j = y; j < y + h; j++) {
                    tile.addComponent("TILE_Y[" + j + "]");
                    tile.addComponent("TILE_XY[" + i + "][" + j + "]");
                    for (var k = z; k < z + 1; k++) {
                        tile.addComponent("TILE_Z[" + k + "]");
                        tile.addComponent("TILE_XZ[" + i + "][" + k + "]");
                        tile.addComponent("TILE_YZ[" + j + "][" + k + "]");
                        tile.addComponent("TILE_XYZ[" + i + "][" + j + "][" + k + "]");
                    }
                }
            }

            return tile;
        },
        placeTile: function(x, y, tileSize, tile) {
            var z = (typeof tile.z !== "undefined") ? tile.z : 0,
                w = (typeof tile.w !== "undefined") ? tile.w : 1,
                h = (typeof tile.h !== "undefined") ? tile.h : 1,
                d = (typeof tile.d !== "undefined") ? tile.d : 1,
                c = (typeof tile.c === "string") ? "2D, Isometric, " + tile.c : "2D, Isometric",
                i = tile.i;

            return this._annotateTile(x, y, z, w, h, d, Crafty.e(c)
                        .attr({ x: x * tileSize, y: y * tileSize, z: z * tileSize,
                                w: w * tileSize, h: h * tileSize, d: d * tileSize })
                        .isometric(i));
        },
        placeTileMap: function(tileSize, map) {
            var mapEntity = Crafty.e("2D").attr({ x: 0, y: 0, z: 0});
            mapEntity.addComponent("TILEMAP");

            var isoMap = [];
            for (var i = 0; i < map.length; i++) {
                isoMap[i] = [];
                for (var j = 0; j < map[i].length; j++) {
                    isoMap[i][j] = [];

                    var tile = map[i][j];
                    if (tile && tile.constructor === Array) {

                        for (var k = 0; k < tile.length; k++) {
                            var subTile = tile[k];
                            if (subTile) {
                                subTile = Object.create(subTile);
                                subTile.z = (typeof subTile.z !== "undefined") ? subTile.z : k;
                                subTile.d = (typeof subTile.d !== "undefined") ? subTile.d : 1;

                                var tileEntity = this.placeTile(i, j, tileSize, subTile);
                                isoMap[i][j][k] = tileEntity;
                                tileEntity._isoMapController = mapEntity;
                                mapEntity.attach(tileEntity);
                            }
                        }

                    } else if (tile) {
                        var tileEntity = this.placeTile(i, j, tileSize, tile);
                        isoMap[i][j][0] = tileEntity;
                        tileEntity._isoMapController = mapEntity;
                        mapEntity.attach(tileEntity);
                    }
                }
            }

            mapEntity._isoControllerMap = isoMap;
            return mapEntity;
        }
    };

    /*****************
     ****** GAME *****
     *****************/
    Crafty.init(600, 600);
    Crafty.background('gray');

    Crafty.sprite(128, 64, "https://raw.githubusercontent.com/craftyjs/demos/master/devDemos/isometric/iso-sprites.png", {
        block: [0,0,1,2],
        player: [1,0,1,2],
        tower: [2,0,1,4],
        big: [0,2,2,3],
        plane: [2,4,1,1]
    });

    // TILSESIZE
    var size = 64;

    // TILES
    var simple = {c: "Solid, Collision", i: "DOM, block"};
    var big = {w: 2, h: 2, c: "Solid, Collision", i: "DOM, big"};
    var plane = {d: 0, i: "DOM, plane"};

    // MAIN TILE MAP
    var map = [ [], [], [], [] ]; // 4x4
    // planes
    map[1][1] = plane;
    map[1][2] = plane;
    map[2][1] = plane;
    // stacked blocks
    map[0][0] = [ simple, simple ];
    map[1][0] = [ plane, plane, plane ];
    map[0][1] = [ plane, plane, plane ];
    map[0][2] = [ simple, simple ];
    map[2][0] = [ simple, simple ];
    map[0][3] = [ simple, simple, simple ];
    map[3][0] = [ simple, simple, simple ];
    var mapEntity = Isometric.placeTileMap(size, map);

    // "TOWER OF POWER" TILE SUBMAP
    towerMap = [ [], [], [], [] ]; // 4 x 4
    towerMap[1][1] = [ big, big, big, big, big ];
    towerMap[2][3] = simple;
    towerMap[3][3] = simple;
    towerMap[3][2] = simple;
    towerMap[3][1] = [null, simple];
    towerMap[3][0] = [null, simple];
    towerMap[2][0] = [null, simple];
    towerMap[1][0] = [null, null, simple];
    towerMap[0][0] = [null, null, simple];
    towerMap[0][1] = [null, null, simple];
    towerMap[0][2] = [null, null, null, simple];
    towerMap[0][3] = [null, null, null, simple];
    towerMap[1][3] = [null, null, null, simple];
    var tower = Isometric.placeTileMap(size, towerMap);
    tower.attr({ x: 7 * size, y: 7 * size });
    mapEntity.attach(tower);


    // VIEWPORT ROTATIONS
    var keyRotations = {};
    keyRotations[Crafty.keys.NUMPAD_4] = 90;
    keyRotations[Crafty.keys.NUMPAD_8] = 0,
    keyRotations[Crafty.keys.NUMPAD_6] = -90,
    keyRotations[Crafty.keys.NUMPAD_2] = -180
    mapEntity.bind("KeyDown", function(e) {
        var rotation = keyRotations[e.key];
        if (typeof rotation !== "undefined") {
            this.rotation = rotation;
        }
    });


    // PLAYER
    var playerEntity = Crafty.e("2D, Multiway, Collision3D, Isometric")
        .attr({ x: 1 * size, y: 1 * size, z: 0 * size,
                w: 1 * size, h: 1 * size, d: 1 * size })
        .collision(1,1, size-1,1, size-1,size-1, 1,size-1)
        .bind("Moved", function(evt) {
            if (this.hit3D('Solid')) {
                this[evt.axis] = evt.oldValue;
            }
        })
        .multiway(100, {
            UP_ARROW: -135, W: -135,
            DOWN_ARROW: 45, S: 45,
            RIGHT_ARROW: -45, D: -45,
            LEFT_ARROW: 135, A: 135
        })
        .bind("KeyDown", function(e) {
            if (e.key === Crafty.keys.SPACE)
                this.z += size;
            else if (e.key === Crafty.keys.CTRL)
                this.z -= size;
        })
        .isometric("2D, DOM, player");
    mapEntity.attach(playerEntity);


    // VIEWPORT
    Crafty.viewport.clampToEntities = false;
    Crafty.viewport.follow(playerEntity._isoDisplay);
    </script>
  </body>
</html>
